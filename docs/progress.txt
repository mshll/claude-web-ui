## 2026-01-16: Phase 1 Task 1 - Add ws dependency, create WebSocket server

### Completed
- Added `ws` and `@types/ws` dependencies to package.json
- Created `api/websocket.ts` with:
  - WebSocket server initialization on `/ws` path
  - Client connection management with unique client IDs
  - Heartbeat mechanism (ping/pong) every 30 seconds
  - `sendToClient()` for targeted messaging
  - `broadcast()` for sending to all connected clients
  - `getConnectedClients()` and `getClientCount()` utility functions
  - Proper cleanup on `stopWebSocket()`
- Integrated WebSocket server with HTTP server in `api/server.ts`
- Added `vitest` for testing with 7 passing tests covering:
  - Server initialization
  - Client connections
  - Connected message delivery
  - Multiple client handling
  - Client disconnect cleanup
  - Broadcast messaging
  - Cleanup on stop

### Files Changed
- `package.json` - Added ws, @types/ws, vitest dependencies; added test scripts
- `api/websocket.ts` - New file: WebSocket server implementation
- `api/server.ts` - Integrated WebSocket initialization and cleanup
- `api/websocket.test.ts` - New file: WebSocket server tests
- `vitest.config.ts` - New file: Test configuration
- `docs/PRD.md` - Marked task complete

---

## 2026-01-16: Phase 1 Task 2 - Implement connection management (multiple clients)

### Completed
- Added message types for client-server communication:
  - `ClientMessage` interface for incoming messages (session.start, message.send, session.interrupt, mode.switch, session.close)
  - `ServerMessage` interface for outgoing messages (connected, session.started, assistant.chunk, terminal.output, session.ended, error)
  - `MessageHandler` type for registering message handlers
- Implemented message handling and routing:
  - `handleClientMessage()` parses JSON and routes to registered handler
  - Error responses for invalid JSON and missing message type
  - Synchronous and async handler error catching
- Implemented session-client association tracking:
  - `sessionClients` Map tracks which clients are in each session
  - `associateClientWithSession()` links client to a session
  - `dissociateClientFromSession()` removes client from session
  - `getClientsBySession()` returns all clients in a session
  - `getClientSession()` returns the session a client is in
  - `sendToSession()` broadcasts to all clients in a session
  - `getActiveSessions()` returns list of active session IDs
- Proper cleanup: clients removed from session tracking on disconnect
- Added 13 new tests (20 total) covering:
  - Message handler invocation
  - Invalid JSON error response
  - Missing type error response
  - Handler error catching
  - Session-client association/dissociation
  - Multiple clients per session
  - Client session switching
  - Session cleanup on disconnect
  - Session-targeted messaging

### Files Changed
- `api/websocket.ts` - Added message types, handler registration, session tracking
- `api/websocket.test.ts` - Added 13 new tests for connection management
- `docs/PRD.md` - Marked task complete

---

## 2026-01-16: Phase 1 Task 3 - Add process-manager for spawning Claude CLI

### Completed
- Created `api/process-manager.ts` with:
  - `spawnClaudeProcess()` - Spawns Claude CLI with JSON streaming flags
  - Support for `--resume <sessionId>` to continue existing sessions
  - Support for `--model <model>` to specify model
  - `projectPath` option sets working directory
  - Process lifecycle tracking (starting, running, stopped)
  - `sendToProcess()` - Writes messages to process stdin
  - `interruptProcess()` - Sends SIGINT to interrupt current operation
  - `killProcess()` - Sends SIGTERM and removes from tracking
  - `killAllProcesses()` - Cleanup for all active processes
  - Event-based output handling via `onProcessOutput()`/`offProcessOutput()`
  - Max concurrent processes limit (10)
  - Automatic cleanup on process exit or error
- Fixed flaky test in websocket.test.ts (race condition in client ID ordering)
- Added 22 new tests (42 total) covering:
  - Process spawning with default args
  - Resume flag with sessionId
  - Model flag
  - Project path as cwd
  - Process info storage
  - Process count tracking
  - Max concurrent processes limit
  - stdout/stderr event emission
  - Status updates on output
  - Exit and error event handling
  - Output handler registration/removal
  - stdin writing
  - SIGINT interrupt
  - SIGTERM kill
  - Active process listing
  - Kill all processes

### Files Changed
- `api/process-manager.ts` - New file: Claude CLI process management
- `api/process-manager.test.ts` - New file: Process manager tests
- `api/websocket.test.ts` - Fixed flaky sendToSession test
- `docs/PRD.md` - Marked task complete

---

## 2026-01-16: Phase 1 Task 4 - Test basic message round-trip

### Completed
- Created `api/session-handler.ts` with:
  - `handleSessionMessage()` - Main message handler for WebSocket messages
  - `session.start` handling: spawns Claude CLI, tracks client-process association
  - `message.send` handling: forwards user messages to process stdin as JSON
  - `session.interrupt` handling: sends SIGINT to interrupt running operations
  - `session.close` handling: kills process and cleans up associations
  - Process output forwarding: stdout/stderr to `assistant.chunk`, exit to `session.ended`
  - Client-process bidirectional mapping for message routing
  - Automatic cleanup on process exit/error
- Integrated session handler with server:
  - Set message handler on WebSocket initialization
  - Added cleanup on server stop
- Added index signature to `ServerMessage` for type compatibility
- Added 15 new tests (57 total) covering:
  - session.start spawns process and returns session.started
  - sessionId passed for resume functionality
  - projectPath passed to set working directory
  - Client-process association tracking
  - Killing existing process when starting new session
  - message.send forwards to process stdin
  - Error when sending without active session
  - Error when content is missing
  - session.interrupt sends SIGINT
  - Error when interrupting without active session
  - session.close kills process and sends session.ended
  - stdout forwarding as assistant.chunk
  - Process exit forwarding as session.ended
  - Process error forwarding as error message
  - Full message round-trip cycle

### Files Changed
- `api/session-handler.ts` - New file: WebSocket-to-process message handler
- `api/session-handler.test.ts` - New file: Session handler tests with mocked process manager
- `api/server.ts` - Integrated session handler and cleanup
- `api/websocket.ts` - Added index signature to ServerMessage interface
- `docs/PRD.md` - Marked task complete

---

## 2026-01-16: Phase 2 Task 1 - Create chat-input component

### Completed
- Created `web/components/chat-input.tsx` with:
  - Text input area with auto-resizing height
  - Send button with cyan styling
  - Interrupt button (red, square icon) shown during processing
  - Submit on Enter, newline on Shift+Enter
  - Disabled state support
  - Input validation (trims whitespace, rejects empty)
  - Clears input after successful send
  - Helpful hint text below input
- Added React testing dependencies:
  - `@testing-library/react` for component rendering
  - `@testing-library/user-event` for user interaction simulation
  - `@testing-library/dom` for DOM utilities
  - `jsdom` for browser environment in tests
- Updated vitest configuration for React component testing
- Added 15 tests (72 total) covering:
  - Rendering with default and custom placeholder
  - onSend callback when clicking send button
  - Input clearing after send
  - Enter key submission
  - Shift+Enter for newline (no submission)
  - Empty input rejection
  - Whitespace-only input rejection
  - Whitespace trimming
  - Disabled state rendering and behavior
  - Interrupt button visibility
  - Send button hiding during processing
  - onInterrupt callback
  - Fallback to send button without onInterrupt

### Files Changed
- `web/components/chat-input.tsx` - New file: Chat input component
- `web/components/chat-input.test.tsx` - New file: Component tests
- `package.json` - Added testing-library and jsdom dependencies
- `vitest.config.ts` - Added React plugin and jsdom environment support
- `docs/PRD.md` - Marked task complete
