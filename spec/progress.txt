## 2026-01-16: Phase 1 Task 1 - Add ws dependency, create WebSocket server

### Completed
- Added `ws` and `@types/ws` dependencies to package.json
- Created `api/websocket.ts` with:
  - WebSocket server initialization on `/ws` path
  - Client connection management with unique client IDs
  - Heartbeat mechanism (ping/pong) every 30 seconds
  - `sendToClient()` for targeted messaging
  - `broadcast()` for sending to all connected clients
  - `getConnectedClients()` and `getClientCount()` utility functions
  - Proper cleanup on `stopWebSocket()`
- Integrated WebSocket server with HTTP server in `api/server.ts`
- Added `vitest` for testing with 7 passing tests covering:
  - Server initialization
  - Client connections
  - Connected message delivery
  - Multiple client handling
  - Client disconnect cleanup
  - Broadcast messaging
  - Cleanup on stop

### Files Changed
- `package.json` - Added ws, @types/ws, vitest dependencies; added test scripts
- `api/websocket.ts` - New file: WebSocket server implementation
- `api/server.ts` - Integrated WebSocket initialization and cleanup
- `api/websocket.test.ts` - New file: WebSocket server tests
- `vitest.config.ts` - New file: Test configuration
- `docs/PRD.md` - Marked task complete

---

## 2026-01-16: Phase 1 Task 2 - Implement connection management (multiple clients)

### Completed
- Added message types for client-server communication:
  - `ClientMessage` interface for incoming messages (session.start, message.send, session.interrupt, mode.switch, session.close)
  - `ServerMessage` interface for outgoing messages (connected, session.started, assistant.chunk, terminal.output, session.ended, error)
  - `MessageHandler` type for registering message handlers
- Implemented message handling and routing:
  - `handleClientMessage()` parses JSON and routes to registered handler
  - Error responses for invalid JSON and missing message type
  - Synchronous and async handler error catching
- Implemented session-client association tracking:
  - `sessionClients` Map tracks which clients are in each session
  - `associateClientWithSession()` links client to a session
  - `dissociateClientFromSession()` removes client from session
  - `getClientsBySession()` returns all clients in a session
  - `getClientSession()` returns the session a client is in
  - `sendToSession()` broadcasts to all clients in a session
  - `getActiveSessions()` returns list of active session IDs
- Proper cleanup: clients removed from session tracking on disconnect
- Added 13 new tests (20 total) covering:
  - Message handler invocation
  - Invalid JSON error response
  - Missing type error response
  - Handler error catching
  - Session-client association/dissociation
  - Multiple clients per session
  - Client session switching
  - Session cleanup on disconnect
  - Session-targeted messaging

### Files Changed
- `api/websocket.ts` - Added message types, handler registration, session tracking
- `api/websocket.test.ts` - Added 13 new tests for connection management
- `docs/PRD.md` - Marked task complete

---

## 2026-01-16: Phase 1 Task 3 - Add process-manager for spawning Claude CLI

### Completed
- Created `api/process-manager.ts` with:
  - `spawnClaudeProcess()` - Spawns Claude CLI with JSON streaming flags
  - Support for `--resume <sessionId>` to continue existing sessions
  - Support for `--model <model>` to specify model
  - `projectPath` option sets working directory
  - Process lifecycle tracking (starting, running, stopped)
  - `sendToProcess()` - Writes messages to process stdin
  - `interruptProcess()` - Sends SIGINT to interrupt current operation
  - `killProcess()` - Sends SIGTERM and removes from tracking
  - `killAllProcesses()` - Cleanup for all active processes
  - Event-based output handling via `onProcessOutput()`/`offProcessOutput()`
  - Max concurrent processes limit (10)
  - Automatic cleanup on process exit or error
- Fixed flaky test in websocket.test.ts (race condition in client ID ordering)
- Added 22 new tests (42 total) covering:
  - Process spawning with default args
  - Resume flag with sessionId
  - Model flag
  - Project path as cwd
  - Process info storage
  - Process count tracking
  - Max concurrent processes limit
  - stdout/stderr event emission
  - Status updates on output
  - Exit and error event handling
  - Output handler registration/removal
  - stdin writing
  - SIGINT interrupt
  - SIGTERM kill
  - Active process listing
  - Kill all processes

### Files Changed
- `api/process-manager.ts` - New file: Claude CLI process management
- `api/process-manager.test.ts` - New file: Process manager tests
- `api/websocket.test.ts` - Fixed flaky sendToSession test
- `docs/PRD.md` - Marked task complete

---

## 2026-01-16: Phase 1 Task 4 - Test basic message round-trip

### Completed
- Created `api/session-handler.ts` with:
  - `handleSessionMessage()` - Main message handler for WebSocket messages
  - `session.start` handling: spawns Claude CLI, tracks client-process association
  - `message.send` handling: forwards user messages to process stdin as JSON
  - `session.interrupt` handling: sends SIGINT to interrupt running operations
  - `session.close` handling: kills process and cleans up associations
  - Process output forwarding: stdout/stderr to `assistant.chunk`, exit to `session.ended`
  - Client-process bidirectional mapping for message routing
  - Automatic cleanup on process exit/error
- Integrated session handler with server:
  - Set message handler on WebSocket initialization
  - Added cleanup on server stop
- Added index signature to `ServerMessage` for type compatibility
- Added 15 new tests (57 total) covering:
  - session.start spawns process and returns session.started
  - sessionId passed for resume functionality
  - projectPath passed to set working directory
  - Client-process association tracking
  - Killing existing process when starting new session
  - message.send forwards to process stdin
  - Error when sending without active session
  - Error when content is missing
  - session.interrupt sends SIGINT
  - Error when interrupting without active session
  - session.close kills process and sends session.ended
  - stdout forwarding as assistant.chunk
  - Process exit forwarding as session.ended
  - Process error forwarding as error message
  - Full message round-trip cycle

### Files Changed
- `api/session-handler.ts` - New file: WebSocket-to-process message handler
- `api/session-handler.test.ts` - New file: Session handler tests with mocked process manager
- `api/server.ts` - Integrated session handler and cleanup
- `api/websocket.ts` - Added index signature to ServerMessage interface
- `docs/PRD.md` - Marked task complete

---

## 2026-01-16: Phase 2 Task 1 - Create chat-input component

### Completed
- Created `web/components/chat-input.tsx` with:
  - Text input area with auto-resizing height
  - Send button with cyan styling
  - Interrupt button (red, square icon) shown during processing
  - Submit on Enter, newline on Shift+Enter
  - Disabled state support
  - Input validation (trims whitespace, rejects empty)
  - Clears input after successful send
  - Helpful hint text below input
- Added React testing dependencies:
  - `@testing-library/react` for component rendering
  - `@testing-library/user-event` for user interaction simulation
  - `@testing-library/dom` for DOM utilities
  - `jsdom` for browser environment in tests
- Updated vitest configuration for React component testing
- Added 15 tests (72 total) covering:
  - Rendering with default and custom placeholder
  - onSend callback when clicking send button
  - Input clearing after send
  - Enter key submission
  - Shift+Enter for newline (no submission)
  - Empty input rejection
  - Whitespace-only input rejection
  - Whitespace trimming
  - Disabled state rendering and behavior
  - Interrupt button visibility
  - Send button hiding during processing
  - onInterrupt callback
  - Fallback to send button without onInterrupt

### Files Changed
- `web/components/chat-input.tsx` - New file: Chat input component
- `web/components/chat-input.test.tsx` - New file: Component tests
- `package.json` - Added testing-library and jsdom dependencies
- `vitest.config.ts` - Added React plugin and jsdom environment support
- `docs/PRD.md` - Marked task complete

---

## 2026-01-16: Phase 2 Task 2 - Implement use-websocket hook

### Completed
- Created `web/hooks/use-websocket.ts` with:
  - `useWebSocket(url, options)` hook for managing WebSocket connections
  - Connection state management (disconnected, connecting, connected)
  - Automatic reconnection with exponential backoff (configurable maxRetries and baseDelay)
  - Client ID and active session ID tracking
  - Message type handlers: onMessage, onSessionStarted, onAssistantChunk, onTerminalOutput, onSessionEnded, onError
  - Convenience methods: startSession(), sendMessage(), interrupt(), closeSession(), switchMode()
  - Generic send() method for custom messages
  - Proper cleanup on unmount
  - Type exports for ClientMessage, ServerMessage, ConnectionStatus
- Updated vitest configuration to include .ts test files
- Added 24 tests (96 total) covering:
  - Initial connecting status
  - Transition to connected on WebSocket open
  - Transition to disconnected on WebSocket close
  - Client ID from connected message
  - Client ID cleared on disconnect
  - Exponential backoff reconnection
  - Max retries limit and error callback
  - Retry count reset on successful connection
  - Cleanup on unmount
  - onMessage callback for all messages
  - onSessionStarted callback and activeSessionId state
  - onAssistantChunk callback
  - onTerminalOutput callback
  - onSessionEnded callback and activeSessionId clearing
  - onError callback
  - Invalid JSON handling
  - send() returns false when disconnected
  - send() sends message when connected
  - startSession() with sessionId and projectPath
  - startSession() without parameters
  - sendMessage() sends content
  - interrupt() sends interrupt message
  - closeSession() sends close message
  - switchMode() sends mode switch message

### Files Changed
- `web/hooks/use-websocket.ts` - New file: WebSocket connection hook
- `web/hooks/use-websocket.test.ts` - New file: Hook tests with mocked WebSocket
- `vitest.config.ts` - Added web/**/*.test.ts to include pattern
- `docs/PRD.md` - Marked task complete

---

## 2026-01-16: Phase 2 Task 3 - Integrate with session-view

### Completed
- Integrated `ChatInput` component and `useWebSocket` hook into `session-view.tsx`:
  - Added WebSocket connection using `useWebSocket` hook
  - ChatInput displayed at bottom of session view
  - Processing state tracking (shows interrupt button when processing)
  - WebSocket URL generation based on current protocol (ws/wss)
  - Automatic session start when first message is sent
  - Interrupt functionality to stop running operations
- Updated `app.tsx` to pass `projectPath` prop to `SessionView`
- Added WebSocket proxy to Vite config for development
- Added `@testing-library/jest-dom` for enhanced test matchers
- Created `vitest.setup.ts` for test setup (jest-dom matchers, scrollIntoView mock)
- Updated vitest configuration with setupFiles
- Added 12 tests (108 total) covering:
  - Initial loading state
  - Chat input rendering after messages load
  - Loading state hiding after messages load
  - "Connecting..." placeholder when WebSocket disconnected
  - Disabled chat input when disconnected
  - startSession called when sending first message
  - startSession skipped when session already active
  - interrupt callback on interrupt button click
  - WebSocket URL format (ws/wss)
  - EventSource URL and offset
  - EventSource recreation on sessionId change

### Files Changed
- `web/components/session-view.tsx` - Integrated ChatInput and useWebSocket
- `web/components/session-view.test.tsx` - New file: Integration tests
- `web/app.tsx` - Pass projectPath to SessionView
- `web/vite.config.ts` - Added /ws WebSocket proxy
- `vitest.setup.ts` - New file: Test setup with jest-dom and scrollIntoView mock
- `vitest.config.ts` - Added setupFiles configuration
- `package.json` - Added @testing-library/jest-dom dependency
- `docs/PRD.md` - Marked task complete
---

## 2026-01-16: Phase 2 Task 4 - Handle message streaming and rendering

### Completed
- Created `web/hooks/use-message-stream.ts` with:
  - `useMessageStream()` hook for accumulating WebSocket chunks into structured messages
  - Parsing of Claude CLI JSON streaming events (assistant, content_block_start, content_block_delta, content_block_stop, message_stop, result)
  - Buffer management for partial lines
  - Support for text, thinking, and tool_use content blocks
  - Deep copy of content blocks to prevent mutation issues
  - `addUserMessage()` for adding user messages to streaming state
  - `clearStreamingMessages()` for resetting state
  - `streamingToConversation()` helper for converting streaming messages to ConversationMessage format
- Integrated message streaming into `session-view.tsx`:
  - Combined historical messages (from EventSource) with streaming messages (from WebSocket)
  - User messages immediately appear when sent
  - Assistant messages stream in real-time with content block updates
  - Auto-scroll triggers on streaming message updates
  - `isStreaming` state controls processing indicator
- Added 23 tests (133 total) covering:
  - Initial state (empty messages, isStreaming false)
  - User message addition with unique IDs
  - Assistant message event handling
  - Content block start events (text, tool_use, thinking)
  - Content block delta events (text_delta, thinking_delta, input_json_delta)
  - Tool input JSON parsing on content_block_stop
  - Message completion (message_stop, result events)
  - Chunk buffering for partial lines
  - Multi-line chunk processing
  - Invalid JSON handling
  - Non-string chunk filtering
  - Clear streaming messages
  - Multiple sequential assistant messages
  - Streaming to conversation message conversion
- Updated session-view tests to mock useMessageStream hook

### Files Changed
- `web/hooks/use-message-stream.ts` - New file: Message streaming hook
- `web/hooks/use-message-stream.test.ts` - New file: Streaming hook tests
- `web/components/session-view.tsx` - Integrated useMessageStream, combined message rendering
- `web/components/session-view.test.tsx` - Added useMessageStream mock and new tests
- `docs/PRD.md` - Marked task complete

---

## 2026-01-16: Phase 2 Task 5 - Add connection status indicator

### Completed
- Created `web/components/connection-status.tsx` with:
  - `ConnectionStatusIndicator` component showing connection state
  - Three status states: connected (green), connecting (amber with pulse), disconnected (zinc)
  - Clean, minimal design with dot indicator and label text
  - Uses `ConnectionStatus` type from use-websocket hook
- Integrated connection status into `session-view.tsx`:
  - Added status indicator in header bar above messages
  - Right-aligned position with subtle border and background
  - Displays current WebSocket connection state
- Added 6 tests (139 total) covering:
  - Connected status with green indicator
  - Connecting status with amber indicator
  - Disconnected status with zinc indicator
  - Pulse animation on connecting status only
  - No pulse animation on connected/disconnected states

### Files Changed
- `web/components/connection-status.tsx` - New file: Connection status indicator component
- `web/components/connection-status.test.tsx` - New file: Component tests
- `web/components/session-view.tsx` - Integrated ConnectionStatusIndicator in header
- `spec/PRD.md` - Marked task complete

---

## 2026-01-16: Phase 3 - Session Management

### Completed
- Added `/api/sessions/active` endpoint to return list of currently active sessions
- Verified graceful shutdown already exists (SIGINT/SIGTERM handlers call `killAllProcesses()`)
- Created `useActiveSessions` hook with:
  - Polling mechanism for active sessions (default 5s interval)
  - Returns Set of active session IDs
  - Proper cleanup on unmount
- Created `NewSessionModal` component with:
  - Project dropdown fetched from `/api/projects` endpoint
  - Loading state while fetching projects
  - Shows project path below dropdown
  - Start Session and Cancel buttons
  - Modal closes on backdrop click or Escape key
- Updated `ProjectSidebar` with:
  - Active session indicator (pulsing green dot) next to active sessions
  - New Session button (+) in header
  - Accepts `activeSessions` and `onNewSession` props
- Updated `SessionView` to:
  - Accept optional `sessionId` (for new sessions without existing history)
  - Skip EventSource connection when no sessionId
- Updated `App` to:
  - Use `useActiveSessions` hook
  - Pass active sessions to `ProjectSidebar`
  - Handle new session modal open/close
  - Support creating new sessions by project path
- Added 15 new tests (154 total) covering:
  - `useActiveSessions` hook: initial state, fetch on mount, polling, error handling, cleanup
  - `NewSessionModal`: rendering, fetching projects, loading state, project selection, submit, close

### Files Changed
- `api/server.ts` - Added `/api/sessions/active` endpoint
- `web/hooks/use-active-sessions.ts` - New file: Hook to poll for active sessions
- `web/hooks/use-active-sessions.test.ts` - New file: Hook tests
- `web/components/new-session-modal.tsx` - New file: Modal for creating new sessions
- `web/components/new-session-modal.test.tsx` - New file: Modal tests
- `web/components/project-sidebar.tsx` - Added active indicators and new session button
- `web/components/session-view.tsx` - Made sessionId optional for new sessions
- `web/app.tsx` - Integrated active sessions and new session modal
- `vitest.config.ts` - Added web/**/*.test.ts to jsdom environment
- `spec/PRD.md` - Marked Phase 3 complete

---

## 2026-01-16: Phase 4 - Terminal Mode

### Completed
- Added node-pty and @xterm/xterm dependencies:
  - `node-pty` for spawning pseudo-terminal processes
  - `@xterm/xterm` for terminal emulation in the browser
  - `@xterm/addon-fit` for auto-fitting terminal to container
  - `@xterm/addon-web-links` for clickable links in terminal output
- Created `api/pty-manager.ts` with:
  - `spawnClaudePty()` - Spawns Claude CLI in a PTY with terminal mode
  - Support for `--resume <sessionId>` to continue existing sessions
  - Configurable terminal dimensions (cols/rows)
  - `writeToPty()` - Writes data to PTY stdin
  - `resizePty()` - Resizes the PTY
  - `killPty()` - Kills PTY and removes from tracking
  - `killAllPtys()` - Cleanup for all active PTYs
  - Event-based output handling via `onPtyOutput()`/`offPtyOutput()`
  - Max concurrent PTYs limit (10)
- Updated `api/session-handler.ts` to support dual-mode sessions:
  - Refactored to use `ClientSession` with mode field ("chat" | "terminal")
  - Added `handleTerminalInput()` for terminal data input
  - Added `handleTerminalResize()` for terminal resize events
  - Updated `handleModeSwitch()` to switch between chat and terminal modes
  - Interrupt in terminal mode sends Ctrl+C (\\x03)
  - PTY output forwarded as `terminal.output` messages
- Updated `api/websocket.ts` message types:
  - Added `terminal.input` and `terminal.resize` client message types
  - Added `cols` and `rows` fields for terminal dimensions
- Created `web/components/terminal-view.tsx` with:
  - `TerminalView` component wrapping xterm.js
  - Custom dark theme matching app design
  - Auto-fit on resize using ResizeObserver
  - Input/resize callback props for WebSocket integration
  - `useTerminalWriter()` hook for writing to terminal from parent
- Updated `web/hooks/use-websocket.ts`:
  - Extended `startSession()` with mode, cols, rows parameters
  - Added `sendTerminalInput()` for terminal data input
  - Added `resizeTerminal()` for terminal resize messages
  - Updated `switchMode()` to include dimensions
- Updated `web/components/session-view.tsx`:
  - Added `ModeToggle` component for switching between Chat and Terminal modes
  - Integrated `TerminalView` component
  - Terminal output from WebSocket written to terminal
  - Terminal input/resize events sent via WebSocket
  - View mode persisted during session
- Added 23 new tests (177 total) covering:
  - PTY spawning with default and custom options
  - PTY write, resize, kill operations
  - PTY output event emission
  - Max concurrent PTYs limit
  - useTerminalWriter hook operations

### Files Changed
- `package.json` - Added node-pty, @xterm/xterm, @xterm/addon-fit, @xterm/addon-web-links
- `api/pty-manager.ts` - New file: PTY process management
- `api/pty-manager.test.ts` - New file: PTY manager tests
- `api/session-handler.ts` - Updated for dual-mode sessions
- `api/websocket.ts` - Added terminal message types
- `web/components/terminal-view.tsx` - New file: xterm.js terminal component
- `web/components/terminal-view.test.tsx` - New file: Terminal hook tests
- `web/components/session-view.tsx` - Added mode toggle and terminal view
- `web/components/session-view.test.tsx` - Updated for new useWebSocket return values
- `web/hooks/use-websocket.ts` - Added terminal-related methods
- `spec/PRD.md` - Marked Phase 4 complete

